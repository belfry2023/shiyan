include io16.inc
assume cs:codeseg, ds:dataseg, ss:stackseg
dataseg segment
;----------- 音符频率表 mus_freq -----------
mus_freq    dw  659, 587, 524, 587     ; 3 2 1 2
            dw  659, 698, 659, 587     ; 3.4 3 2.
            dw  659, 587, 524, 587     ; 3 2 1 2
            dw  659, 698, 659, 587     ; 3.4 3 2.

            ; 重复段落
            dw  659, 587, 524, 587     ; 3 2 1 2
            dw  659, 698, 659, 587     ; 3.4 3 2.
            dw  659, 587, 524, 587     ; 3 2 1 2
            dw  659, 698, 659, 587, 262, 294    ; 3.4 3 2. 1 2

            ; 主旋律
            dw  330, 330, 294, 349, 330, 294  ;3 3 2 4 3 2
            dw  294, 294, 262, 262           ;2 2 1 1
            dw  349, 330, 294                 ;4 3 2
            dw  294, 262, 294, 330            ;2 1 2 3.

            ; 间奏
            dw  0, 330, 392, 523              ;0. 351
            dw  494, 524, 494, 524            ;7 i 7 i
            dw  494, 440, 392, 392, 294, 262       ;76 5 524
            dw  349, 330, 330, 392            ;4 3 3 5
            dw  349, 330, 294, 330, 196            ;432 3 5

            ; 主歌
            dw  262, 0, 262             ;1. 0 1
            dw  294, 262, 262            ;21.1
            dw  262, 392, 262                 ;151
            dw  349, 330, 294, 262            ;4 3 2 1
            dw  262, 0, 262, 294              ;1.0 12

           ; 主旋律
            dw  330, 330, 294, 349, 330, 294  ;3 3 2 4 3 2
            dw  294, 294, 262           ;2 2 1
            dw  349, 330, 294                 ;4 3 2
            dw  294, 262, 294, 330            ;2 1 2 3.

            ; 间奏
            dw  0, 330, 392, 523              ;0. 351
            dw  494, 524, 494, 524            ;7 i 7 i
            dw  494, 440, 392, 392, 294, 262       ;76 5 524
            dw  349, 330, 330, 392            ;4 3 3 5
            dw  349, 330, 294, 330, 196            ;432 3 5

            ; 副歌
            dw  262, 0, 262, 262              ;1. 0 11
            dw  294, 262, 262, 392, 262        ;21 151
            dw  349, 349, 349, 330, 294, 294, 262  ;4 4 4 3 2 21
            dw  262, 0, 0                   ;1.0 0.

            ; 桥段（完整展开）
            dw  880, 784, 784, 784, 698, 698   ;655 544
            dw  659, 587, 587, 587, 0, 392          ;322 205
            dw  392, 349, 349, 349, 349, 330, 294   ;544 4 432
            dw  294, 262, 247, 162, 0               ;217 1.0.

            ; 重复桥段
            dw  880, 784, 784, 784, 698, 698   ;655 544
            dw  659, 587, 587, 587, 0, 330          ;322 203
            dw  330, 330, 330, 330, 330, 330, 294, 330   ;333 33 323
            dw  587, 524, 524, 0, 524             ;2 i 101

            ; 尾奏
            dw  494, 440, 440               ;7 6 6.
            dw  0, 440, 440, 392, 349, 349          ;0 6 654 4
            dw  349, 330, 349, 392             ;4.34 5
            dw  392, 0                      ;5.0.
            dw  -1                             ; 结束标志

;----------- 音符时值表 mus_time -----------
mus_time    dw  24,12,24,12, 18,6,12,36      ; 基础节奏
            dw  24,12,24,12, 18,6,12,36      ; 重复段落
            dw  24,12,24,12, 18,6,12,36
            dw  24,12,24,12, 18,6,12,24,6,6

            ; 主旋律时值
            dw  12,12,12,12,12,12            ;3 3 2 4 3 2
            dw  12,12,6,6                 ;2 2 1 1
            dw  12,12,12                     ;4 3 2
            dw  24,6,6,36                 ;2 1 2 3.

            ; 间奏时值
            dw  36,12,12,12                  ;0.351 (附点)
            dw  24,12,24,12                  ;7i7i
            dw  6,6,24,12,12,12               ;76 5 524
            dw  24,12,24,12                  ;4 3 3 5
            dw  12,12,12,24,12                  ;432 3 5

            ; 主歌时值
            dw  36,24,12                  ;1. 0 1
            dw  12,18,6                  ;21.1
            dw  12,12,12                     ;151
            dw  24,12,24,12                  ;4 3 2 1
            dw  36,24,6,6                  ;1.0 12

            ; 重复时值（完全展开）
            dw  12,12,12,12,12,12            ;3 3 2 4 3 2
            dw  12,12,12                 ;2 2 1
            dw  12,12,12                     ;4 3 2
            dw  24,6,6,36                 ;2 1 2 3.

            ; 间奏时值重复
            dw  36,12,12,12                  ;0.351 (附点)
            dw  24,12,24,12                  ;7i7i
            dw  6,6,24,12,12,12               ;76 5 524
            dw  24,12,24,12                  ;4 3 3 5
            dw  12,12,12,24,12                  ;432 3 5

            ; 副歌时值
            dw  36,24,6,6                  ;1. 0 11
            dw  12,24,12,12,12               ;21 151
            dw  12,6,6,6,6,24,12            ;4 4 4 3 2 21
            dw  18,18,36                  ;1.0 0.

            ; 桥段时值
            dw  12,12,12,12,12,12            ;655 544
            dw  12,12,12,12,12,12               ;322 205
            dw  12,6,6,12,12,12,12            ;544 4 432
            dw  24,6,6,18,18                  ;217 1.0.

            ; 重复桥段时值
            dw  12,12,12,12,12,12            ;655 544
            dw  12,12,12,12,12,12               ;322 203
            dw  12,6,6,6,6,12,12,12            ;333 33 323
            dw  24,12,12,12,12                  ;2 i 101

            ; 尾奏时值
            dw  24,12,36                     ;7 6 6.
            dw  24,12,12,12,6,6               ;0 6 654 4
            dw  36,6,6,24                  ;4.34 5
            dw  36,36                     ;5.0.
            dw  -1                            ; 结束标志
dataseg ends

stackseg segment
   db 100h dup (0)
stackseg ends

codeseg segment
start:
    mov ax, stackseg
    mov ss, ax
    mov sp, 100h

    mov ax, dataseg
    mov ds, ax

    lea si, mus_freq
    lea di, mus_time

play:
    mov dx, [si]
    cmp dx, -1
    je end_play
    cmp dx, 0
    je silence
    call sound
    add si, 2
    add di, 2
    jmp play

silence:
    ;========= 新增扬声器关闭操作 =========
    in al, 61h         ; 读取端口状态
    and al, 0FCh       ; 清除位0和位1 (11111100b)
    out 61h, al        ; 关闭扬声器
    ;====================================
    
    mov dx, [di]       ; 获取静音时长
    call delay         ; 使用统一延时
    
    add si, 2          ; 移动到下一个音符
    add di, 2
    jmp play

end_play:
    mov ax, 4c00h
    int 21h

;演奏一个音符
;入口参数：si - 要演奏的音符的频率的地址
;         di - 要演奏的音符的音长的地址
sound:
    push ax
    push dx
    push cx

    ; 初始化8253定时器
    mov al, 0B6h
    out 43h, al
    mov dx, 12h
    mov ax, 34DCh
    div word ptr [si]
    out 42h, al
    mov al, ah
    out 42h, al

    ; 打开扬声器
    in al, 61h
    mov ah, al
    or al, 03h         ; 设置位0和位1
    out 61h, al

    mov dx, [di]       ; 获取音符时长
    call delay         ; 调用统一延时

    ; 关闭扬声器
    mov al, ah         ; 恢复原始端口状态
    out 61h, al

    pop cx
    pop dx
    pop ax
    ret

delay proc
    push cx
wait_delay:
    mov cx, 21000      ; 与原有延时基数一致
delay_loop:
    nop
    loop delay_loop
    dec dx
    jnz wait_delay
    pop cx
    ret
delay endp

codeseg ends
end start